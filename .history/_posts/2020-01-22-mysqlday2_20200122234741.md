---
layout: post
title: MYSQL 更新的语句是怎么执行的？
subtitle: 说实在的！我感觉自己越来越无法融入世俗社会！！
---
 可能听 DBA　的同事说,半个月以内的任意一秒,那就让我们看这是怎么做到的.

 更新语句同样会经过连接器,查询缓存,分析器,优化器,执行器这些流程.

 但是与查询不同的是,更新还与两个重要的日志模块相关, redo log 和 binlog.


 ### 题外话

 在<<孔乙己>> 中,酒店掌柜一个粉板和一本账本,记录记录客人的赊账情况.如果客人少,掌柜会在粉板上直接进行记录,当生意比较好的时候,粉板已经记不下了,此时掌柜会擦除一部分粉板内容,整合到账本上,在进行记录.

 而 redo log 相当于其中的"粉板", binlog 则对应其中的"账本".在小说中,粉板直接记录比较容易,而账本整合记录的过程比较耗时,对应 MYSQL 中, redo log 是存放在内存中存储方便,而 binlog 则需要持久化到磁盘中,比较耗资源.


 整合的这个过程,在 MYSQL 中就是经常提到的 WAL 技术, 全称为 Write Ahead Logging ,关键点是先写日志,再写磁盘,也就是先写 "粉板",在不忙的时候,在整合到 "账本".
### redo log
 InnoDB 的 redo log 是固定大小的,比如可以配置为一组 4 个文件，每个文件的大小是 1GB，那么这块“粉板”总共就可以记录 4GB 的操作。

 其中有两个重要的位置 write pos 和 check pos.前一个是当前可以写的起始位置,后一个为擦除的起始位置.

 有了 redo log，InnoDB 就可以保证即使数据库发生异常重启，之前提交的记录都不会丢失，这个能力称为 crash-safe。

### binlog

MySQL 整体来看，其实就有两块：一块是 Server 层，它主要做的是 MySQL 功能层面的事情；还有一块是引擎层，负责存储相关的具体事宜。

前面所提到的 redo log 是 InnoDB引擎特有的日志, 而 Server  层自己的日志称为 binlog.

为什么需要两日志,因为一份日志无法做到 crash-safe.

这两种日志的区别:
* redo log 是 InnoDB 引擎特有的；binlog 是 MySQL 的 Server 层实现的，所有引擎都可以使用。
* redo log 是物理日志，记录的是“在某个数据页上做了什么修改”；binlog 是逻辑日志，记录的是这个语句的原始逻辑，比如“给 ID=2 这一行的 c 字段加 1 ”。
* redo log 是循环写的，空间固定会用完；binlog 是可以追加写入的。“追加写”是指 binlog 文件写到一定大小后会切换到下一个，并不会覆盖以前的日志。

有了这两种日志,让我们看看 MYSQL 更新语句执行流程是怎么样的?
例子:

~~~ bash

mysql> update T set c=c+1 where ID=2;

~~~

i
